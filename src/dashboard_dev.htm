<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Meteo clock setup</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link href="//cdn.muicss.com/mui-0.10.3/css/mui.min.css" rel="stylesheet" type="text/css"/>
    <script src="//cdn.muicss.com/mui-0.10.3/js/mui.min.js"></script>
</head>
<body class="mui-container">
<div class="mui-panel">
    <h2>Status</h2>
    <p>
        CO2: <span id="co2Value"></span> ppm; Status: <span id="co2Status"></span>
    </p>
    <p>
        Pressure: <span id="pressure"></span> Pa; Temperature: <span id="temperature"></span>Â°C; Humidity: <span
            id="humidity"></span>%
    </p>
    <p>
        Rain: <span id="rain"></span>%
    </p>
    <p style="display: flex; align-items: center; gap: 20px">
        Time: <span id="time"></span>
        <button type="button" class="mui-btn mui-btn--primary" onclick="postTime()">Set current</button>
    </p>
</div>
<div class="mui-panel">
    <h2>Update</h2>
    <form action="/update" method="POST">
        <p>
            <label for="LedValue">Led value:</label>
            <select id="LedValue" name="ledValue">
                <option value="0">Off</option>
                <option value="1">Red</option>
                <option value="2">Green</option>
                <option value="3">Blue</option>
                <option value="4">Yellow</option>
            </select>
        </p>
        <p>
            <label for="ModeValue">Mode:</label>
            <select id="ModeValue" name="modeValue">
                <option value="0">Clock</option>
                <option value="1">Temperature hourly</option>
                <option value="2">Temperature daily</option>
                <option value="3">Humidity hourly</option>
                <option value="4">Humidity daily</option>
                <option value="5">Pressure hourly</option>
                <option value="6">Pressure daily</option>
                <option value="7">CO2 hourly</option>
                <option value="8">CO2 daily</option>
                <option value="9">Rain hourly</option>
                <option value="10">Rain daily</option>
            </select>
        </p>
        <p>
            <label for="LcdText">LCD Text:</label>
            <input id="LcdText" name="lcdText"/>
        </p>
        <p>
            <label for="LogsEnabled">Logs:</label>
            <input type="checkbox" id="LogsEnabled" name="logsEnabled">

            <label for="LogsHost">Host:</label>
            <input id="LogsHost" name="logsHost">

            <label for="LogsPort">Port:</label>
            <input id="LogsPort" name="logsPort">
        </p>
        <button type="submit" class="mui-btn mui-btn--primary">Save</button>
    </form>
</div>
<div class="mui-panel">
    <h2>Wi-Fi</h2>
    <form action="/wifi" method="POST">
        <p>
            <label for="WiFiSSID">SSID:</label>
            <input id="WiFiSSID" name="wifiSSID">

            <label for="WiFiPassword">Password:</label>
            <input id="WiFiPassword" name="wifiPassword" type="password">
        </p>
        <button type="submit" class="mui-btn mui-btn--primary">Save & Restart</button>
    </form>
</div>
<script>
    // test-data-start
    const currentData = {
        "ledValue": 3,
        "modeValue": 3,
        "photoValue": 341,
        "co2": {"status": 0, "value": 1135},
        "bme": {"pressure": 97773.60156, "temperature": 27.42000008, "humidity": 52},
        "time": {"iso": "2023-07-02T01:11:14"},
        "rain": 30,
        "logs": {enabled: true, host: "my.local", port: 8000},
        "wifi": {"ssid": "WWW"}
    };
    // test-data-end
    const {
        ledValue,
        modeValue,
        co2: {status: co2Status, value: co2Value},
        bme: {pressure, temperature, humidity},
        time: {iso: isoTime},
        rain,
        logs: {enabled: logsEnabled, host: logsHost, port: logsPort},
        wifi: {ssid}
    } = currentData;
    $('#co2Status').text(co2Status);
    $('#co2Value').text(co2Value);
    $('#pressure').text(pressure.toFixed(2));
    $('#temperature').text(temperature.toFixed(1));
    $('#humidity').text(humidity);
    $('#time').text(isoTime);
    $('#rain').text(rain);

    $(`#LedValue option[value="${ledValue}"]`).prop('selected', true);
    $(`#ModeValue option[value="${modeValue}"]`).prop('selected', true);
    $("#LogsEnabled").prop('checked', logsEnabled);
    $("#LogsHost").val(logsHost);
    $("#LogsPort").val(logsPort);
    $("#WiFiSSID").val(ssid);
</script>
<script>
    async function postTime() {
        const rawEpochTime = Date.now().valueOf();
        const timezoneOffset = new Date().getTimezoneOffset();
        const timezoneOffsetMs = timezoneOffset * 60 * 1000;
        const adjustedEpochTime = rawEpochTime - timezoneOffsetMs;
        const body = new URLSearchParams();
        body.append('datetime', adjustedEpochTime);
        const response = await fetch('/datetime', {
            method: 'POST',
            body
        });
        if (response.ok) {
            window.location.href = response.url;
        }
    }
</script>
</body>
</html>